<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <title>Task Tracker - Turing Tooling</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        h1, h2 {
            color: #667eea !important;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: black;
            min-height: 100vh;
            color: white;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .task-tracker-section {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .tracker-header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
            padding: 2rem 0;
            // max-width: 900px;
        }

        .header-visual {
            position: relative;
            margin-bottom: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .task-icon {
            animation: float 6s ease-in-out infinite;
            filter: drop-shadow(0 10px 20px rgba(102, 126, 234, 0.3));
        }

        .subtitle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem 0 1.5rem 0;
            gap: 1rem;
        }

        .subtitle-line {
            height: 1px;
            width: 60px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
        }

        .subtitle {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .feature-highlights {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .highlight-tag {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .highlight-tag:hover {
            transform: translateY(-2px);
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        @keyframes orbit {
            0% { transform: rotate(0deg) translateX(50px) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(50px) rotate(-360deg); }
        }

        .tracker-header h1 {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tracker-description {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            .tracker-header h1 {
                font-size: 2.2rem;
            }

            .tracker-description {
                font-size: 1rem;
            }

            .feature-highlights {
                justify-content: center;
                gap: 0.5rem;
            }

            .highlight-tag {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }

        .filters-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .filters-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }

        .reload-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .reload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .reload-button:active {
            transform: translateY(0);
        }

        .reload-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .filter-select, .filter-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .filter-select option {
            background: #2a2a2a;
            color: white;
        }

        .analytics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 24px;
            padding: 2.5rem 2rem;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            height: 320px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .analytics-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.8s ease;
        }

        .analytics-card:hover::before {
            left: 100%;
        }

        .analytics-card:hover {
            transform: translateY(-10px);
            border-color: rgba(102, 126, 234, 0.4);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 
                0 20px 40px rgba(102, 126, 234, 0.2),
                0 10px 20px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .analytics-number {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .analytics-label {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1rem;
        }

        .analytics-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
        }

        .tasks-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            min-height: 400px;
        }

        .tasks-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .task-table th,
        .task-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .task-table th {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .task-table td {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
        }

        .task-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .week-cell {
            font-weight: 600;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .date-cell {
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .name-cell {
            color: #4CAF50;
            font-weight: 500;
        }

        .total-cell {
            background: rgba(102, 126, 234, 0.15);
            font-weight: bold;
            color: #667eea;
        }

        .complexity-expert {
            color: #ff6b6b;
            font-weight: 600;
        }

        .complexity-hard {
            color: #ffa726;
            font-weight: 600;
        }

        .complexity-medium {
            color: #66bb6a;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 15px;
        }

        .no-data {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 3rem;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .task-tracker-section {
                padding: 0 1rem;
            }

            .tracker-header h1 {
                font-size: 2.2rem;
            }

            .tracker-description {
                font-size: 1rem;
            }

            .filters-container {
                padding: 1.5rem;
            }

            .filters-header {
                flex-direction: column;
                gap: 1rem;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .analytics-container {
                grid-template-columns: 1fr;
            }

            .analytics-number {
                font-size: 2rem;
            }

            .task-table th,
            .task-table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
    <script>
        var github_username_mapping = new Object();
        var tasks_info = null;
        var username_email_mapping = {};
        
        ////////// TEAM STRUCTURE CONSTANTS ////////////
        var pods = new Set();
        var calibrators = new Set();
        var trainers = new Set();
        var pod_trainers = new Map();
        var podFiltered = false;
        var lastPodFilter = null;
        ////////// TEAM STRUCTURE CONSTANTS ////////////

        // Function to get day name from date
        function getDayName(dateString) {
            const date = new Date(dateString);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        // Function to populate dropdown options
        function populateDropdowns() {
            populateWeekDropdown();
            populatePodDropdown();
            populateTrainerDropdown();
            populateComplexityDropdown();
        }

        function populateWeekDropdown() {
            const weekSelect = document.getElementById('weekFilter');
            const weeks = new Set();
            
            if (tasks_info) {
                tasks_info.forEach(task => {
                    if (task['Week num']) {
                        weeks.add(task['Week num']);
                    }
                });
            }

            weekSelect.innerHTML = '<option value="all">All Weeks</option>';
            Array.from(weeks).sort().forEach(week => {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = week.replace('_', ' ').toUpperCase();
                weekSelect.appendChild(option);
            });
        }

        function populatePodDropdown() {
            const podSelect = document.getElementById('podFilter');
            const podsList = Array.from(pods);
            
            podSelect.innerHTML = '<option value="all">All Pods</option>';
            podsList.forEach(pod => {
                if (pod && pod.trim()) {
                    const option = document.createElement('option');
                    option.value = pod;
                    option.textContent = pod;
                    podSelect.appendChild(option);
                }
            });
        }

        function populateTrainerDropdown() {
            const trainerSelect = document.getElementById('trainerFilter');
            
            const trainersList = Array.from(trainers);
            trainerSelect.innerHTML = '<option value="all">All Trainers</option>';
            trainersList.forEach(trainer => {
                if (trainer && trainer.trim()) {
                    const option = document.createElement('option');
                    option.value = trainer;
                    option.textContent = trainer;
                    trainerSelect.appendChild(option);
                }
            });
        }

        function populateComplexityDropdown() {
            const complexitySelect = document.getElementById('complexityFilter');
            const complexities = new Set();
            
            if (tasks_info) {
                tasks_info.forEach(task => {
                    if (task['Complexity']) {
                        complexities.add(task['Complexity']);
                    }
                });
            }

            complexitySelect.innerHTML = '<option value="all">All Complexities</option>';
            Array.from(complexities).sort().forEach(complexity => {
                const option = document.createElement('option');
                option.value = complexity;
                option.textContent = complexity.charAt(0).toUpperCase() + complexity.slice(1);
                complexitySelect.appendChild(option);
            });
        }

        // Function to generate table data based on filters
        function generateTableData() {
            if (!tasks_info || tasks_info.length === 0) {
                return null;
            }
            
            // Get filter values
            const podFilter = document.getElementById('podFilter').value;
            const trainerSelect = document.getElementById('trainerFilter');

            if (podFilter != 'all'){
                if (!podFiltered || lastPodFilter !== podFilter) {
                    trainerSelect.innerHTML = '';
                    trainerSelect.innerHTML = '<option value="all">All Trainers</option>';
                    const podTrainers = pod_trainers.get(podFilter) || new Set();
                    podTrainers.forEach(trainer => {
                        if (trainer && trainer.trim()) {
                            const option = document.createElement('option');
                            option.value = trainer;
                            option.textContent = trainer;
                            trainerSelect.appendChild(option);
                        }
                    });
                    podFiltered = true;
                    lastPodFilter = podFilter;
                }
            } else {
                if (podFiltered) {
                    populateTrainerDropdown();
                    podFiltered = false;
                }
            }

            const weekFilter = document.getElementById('weekFilter').value;
            const trainerFilter = document.getElementById('trainerFilter').value;
            const complexityFilter = document.getElementById('complexityFilter').value;

            /* console.log('Filters:', {
                weekFilter,
                podFilter,
                trainerFilter,
                complexityFilter
            }); */


            // Filter tasks based on selected filters
            let filteredTasks = tasks_info.filter(task => {
                if (github_username_mapping[task['GitHub username'].toLowerCase()] === trainerFilter){
                    console.log('Trainer Filter Match:', task['GitHub username'], '->', github_username_mapping[task['GitHub username'].toLowerCase()]);
                }
                return (weekFilter === 'all' || task['Week num'] === weekFilter) &&
                       (podFilter === 'all' || task['Lead'] === podFilter) &&
                       (trainerFilter === 'all' || github_username_mapping[task['GitHub username'].toLowerCase()] === trainerFilter) &&
                       (complexityFilter === 'all' || task['Complexity'] === complexityFilter);
            });

            console.log('Filtered Tasks:', trainerFilter);


            // Group by week, date, and user
            const groupedData = {};
            
            filteredTasks.forEach(task => {
                const week = task['Week num'] || 'Unknown Week';
                const createdDate = new Date(task['Created Date (completed)']);
                const dateKey = createdDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                const dayName = getDayName(task['Created Date (completed)']);
                const username = task['GitHub username'].toLowerCase() || 'Unknown User';
                const actual_name = github_username_mapping[username] || username;
                const complexity = task['Complexity'] || 'unknown';

                if (!groupedData[week]) {
                    groupedData[week] = {};
                }
                if (!groupedData[week][dayName]) {
                    groupedData[week][dayName] = {
                        dayName: dayName,
                        users: {}
                    };
                }
                if (!groupedData[week][dayName].users[actual_name]) {
                    groupedData[week][dayName].users[actual_name] = {
                        expert: 0,
                        hard: 0,
                        medium: 0,
                        total: 0
                    };
                }

                groupedData[week][dayName].users[actual_name][complexity]++;
                groupedData[week][dayName].users[actual_name].total++;
            });

            /* const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            for (const week in groupedData) {
                for (const dayName of days) {
                    if (!groupedData[week][dayName]) {
                        groupedData[week][dayName] = {
                            dayName: dayName,
                            users: {}
                        };
                    }
                }
            }
            // Sort weeks and dates
            const sortedWeeks = Object.keys(groupedData).sort((a, b) => {
                const weekA = a.replace('_', ' ').toUpperCase();
                const weekB = b.replace('_', ' ').toUpperCase();
                return weekA.localeCompare(weekB);
            }); */
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                    // Ensure all days exist for each week in the correct order
            for (const week in groupedData) {
                // Create a new ordered object for this week
                const orderedWeekData = {};
                
                // Add days in the correct order (Monday to Sunday)
                days.forEach(dayName => {
                    if (groupedData[week][dayName]) {
                        orderedWeekData[dayName] = groupedData[week][dayName];
                    } else {
                        orderedWeekData[dayName] = {
                            dayName: dayName,
                            users: {}
                        };
                    }
                });
                
                // Replace the week data with the ordered version
                groupedData[week] = orderedWeekData;
            }

            // Sort weeks
            const sortedWeeks = Object.keys(groupedData).sort((a, b) => {
                const weekA = a.replace('_', ' ').toUpperCase();
                const weekB = b.replace('_', ' ').toUpperCase();
                return weekA.localeCompare(weekB);
            });

            // Create final sorted structure
            const sortedGroupedData = {};
            sortedWeeks.forEach(week => {
                sortedGroupedData[week] = groupedData[week];
            });

            return groupedData;
        }

        // Function to render the table
        // Replace the existing renderTable function with this modified version
        // Replace the existing renderTable function with this modified version
function renderTable() {
    const tableData = generateTableData();
    const tableContainer = document.getElementById('tasksDisplay');
    
    if (!tableData || Object.keys(tableData).length === 0) {
        tableContainer.innerHTML = '<div class="no-data">No data available for the selected filters</div>';
        return;
    }

    // Define days in correct order (Monday to Sunday)
    const daysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    // Get all unique users across all filtered data
    const allUsers = new Set();
    Object.values(tableData).forEach(weekData => {
        Object.values(weekData).forEach(dateData => {
            Object.keys(dateData.users).forEach(user => allUsers.add(user));
        });
    });

    const users = Array.from(allUsers).sort();

    let tableHTML = `
        <div class="table-wrapper">
            <table class="task-table">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Date</th>`;

    // Add user columns
    users.forEach(user => {
        tableHTML += `
            <th colspan="4">${user}</th>`;
    });

    tableHTML += `</tr><tr>
                        <th></th>
                        <th></th>`;

    // Add complexity headers for each user
    users.forEach(user => {
        tableHTML += `
            <th class="complexity-expert">Expert</th>
            <th class="complexity-hard">Hard</th>
            <th class="complexity-medium">Medium</th>
            <th class="total-cell">Total</th>`;
    });

    tableHTML += `</tr></thead><tbody>`;

    // Add data rows
    Object.keys(tableData).sort().forEach(week => {
        const weekData = tableData[week];
        let weekTotals = {};
        users.forEach(user => {
            weekTotals[user] = { expert: 0, hard: 0, medium: 0, total: 0 };
        });

        // Show all days (Monday to Sunday) for each week
        daysOrder.forEach(dayName => {
            // Get data for this day, or create empty structure if it doesn't exist
            const dateData = weekData[dayName] || {
                dayName: dayName,
                users: {}
            };
            
            tableHTML += `
                <tr>
                    <td class="week-cell">${week.replace('_', ' ').toUpperCase()}</td>
                    <td class="date-cell">${dateData.dayName}</td>`;

            users.forEach(user => {
                const userData = dateData.users[user] || { expert: 0, hard: 0, medium: 0, total: 0 };
                weekTotals[user].expert += userData.expert;
                weekTotals[user].hard += userData.hard;
                weekTotals[user].medium += userData.medium;
                weekTotals[user].total += userData.total;

                tableHTML += `
                    <td class="complexity-expert">${userData.expert}</td>
                    <td class="complexity-hard">${userData.hard}</td>
                    <td class="complexity-medium">${userData.medium}</td>
                    <td class="total-cell">${userData.total}</td>`;
            });

            tableHTML += `</tr>`;
        });

        // Add week total row
        tableHTML += `
            <tr class="week-total-row" style="border-top: 2px solid rgba(102, 126, 234, 0.8); background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2)); font-weight: bold;">
                <td class="week-cell" style="background: rgba(102, 126, 234, 0.3); color: #667eea; font-weight: bold;">${week.replace('_', ' ').toUpperCase()}</td>
                <td class="total-cell" style="background: rgba(102, 126, 234, 0.25); color: #667eea; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Total</td>`;

        users.forEach(user => {
            tableHTML += `
                <td class="complexity-expert" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b; font-weight: bold; border: 1px solid rgba(255, 107, 107, 0.3);">${weekTotals[user].expert}</td>
                <td class="complexity-hard" style="background: rgba(255, 167, 38, 0.2); color: #ffa726; font-weight: bold; border: 1px solid rgba(255, 167, 38, 0.3);">${weekTotals[user].hard}</td>
                <td class="complexity-medium" style="background: rgba(102, 187, 106, 0.2); color: #66bb6a; font-weight: bold; border: 1px solid rgba(102, 187, 106, 0.3);">${weekTotals[user].medium}</td>
                <td class="total-cell" style="background: rgba(102, 126, 234, 0.3); color: #667eea; font-weight: bold; border: 2px solid rgba(102, 126, 234, 0.5); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">${weekTotals[user].total}</td>`;
        });

        tableHTML += `</tr>`;

        // Add distribution percentage row
        tableHTML += `
            <tr class="week-distribution-row" style="border-top: 1px solid rgba(118, 75, 162, 0.6); background: linear-gradient(135deg, rgba(118, 75, 162, 0.15), rgba(102, 126, 234, 0.15)); font-style: italic;">
                <td class="week-cell" style="background: rgba(118, 75, 162, 0.25); color: #764ba2; font-weight: bold; font-style: italic;">${week.replace('_', ' ').toUpperCase()}</td>
                <td class="total-cell" style="background: rgba(118, 75, 162, 0.2); color: #764ba2; font-weight: bold; font-style: italic; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">Distribution</td>`;

        users.forEach(user => {
            const total = weekTotals[user].total;
            let expertPercent = '0.0%';
            let hardPercent = '0.0%';
            let mediumPercent = '0.0%';

            if (total > 0) {
                expertPercent = ((weekTotals[user].expert / total) * 100).toFixed(1) + '%';
                hardPercent = ((weekTotals[user].hard / total) * 100).toFixed(1) + '%';
                mediumPercent = ((weekTotals[user].medium / total) * 100).toFixed(1) + '%';
            }

            tableHTML += `
                <td class="complexity-expert" style="background: rgba(255, 107, 107, 0.15); color: #ff8a80; font-weight: 600; font-style: italic; border: 1px solid rgba(255, 107, 107, 0.2); text-shadow: 0 1px 1px rgba(0,0,0,0.2);">${expertPercent}</td>
                <td class="complexity-hard" style="background: rgba(255, 167, 38, 0.15); color: #ffb74d; font-weight: 600; font-style: italic; border: 1px solid rgba(255, 167, 38, 0.2); text-shadow: 0 1px 1px rgba(0,0,0,0.2);">${hardPercent}</td>
                <td class="complexity-medium" style="background: rgba(102, 187, 106, 0.15); color: #81c784; font-weight: 600; font-style: italic; border: 1px solid rgba(102, 187, 106, 0.2); text-shadow: 0 1px 1px rgba(0,0,0,0.2);">${mediumPercent}</td>
                <td class="total-cell" style="background: rgba(118, 75, 162, 0.25); color: #764ba2; font-weight: bold; font-style: italic; border: 2px solid rgba(118, 75, 162, 0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.3);">100.0%</td>`;
        });

        tableHTML += `</tr>`;
    });

    tableHTML += `</tbody></table></div>`;
    tableContainer.innerHTML = tableHTML;
}

        // Function to reload tracker data
        function reloadTrackerData() {
            const reloadBtn = document.getElementById('reloadBtn');
            const originalText = reloadBtn.innerHTML;
            const spinner = '<span class="loading-spinner"></span>';
            
            reloadBtn.innerHTML = spinner + ' Reloading...';
            reloadBtn.disabled = true;

            // Simulate API call to reload tracker data
            fetch('/tracker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Tracker data reloaded:', data);
                reloadBtn.innerHTML = 'Reloaded &#10003;';
                tasks_info = data.tasks_info || [];
                username_email_mapping = data.username_email_mapping || {};
                
                for (const user of username_email_mapping) {
                    if (user["Github Username"]) {
                        github_username_mapping[user['Github Username'].toLowerCase()] = user['Actual name'];
                    }
                }
                console.log('GitHub Username to Name Mapping:', github_username_mapping);
                

                var show_trainer_pod = new Map();
                for (const team_structure of data.team_structure) {
                    pods.add(team_structure['Pod Lead']);
                    calibrators.add(team_structure['Calibrator']);
                    
                    trainers_of_pod = new Set();
                    const partialKey = 'Trainer';
                    for (const key in team_structure) {
                        if (key.startsWith(partialKey)) {
                            trainers.add(team_structure[key]);
                            show_trainer_pod.set(team_structure[key], team_structure['Pod Lead']);
                            trainers_of_pod.add(team_structure[key])
                        }
                    }
                    pod_trainers.set(team_structure['Pod Lead'], trainers_of_pod);
                }

                console.log('Pods:', pod_trainers);
                console.log('Pods:', show_trainer_pod);

                for (const task of tasks_info) {
                    if (!task['Lead'] || task['Lead'] === "Unknown Pod") {
                        /* if (task['GitHub username'] == 'khomesh02') {
                            console.log(github_username_mapping[task['GitHub username'].toLowerCase()])
                            console.log(show_trainer_pod.get(github_username_mapping[task['GitHub username'].toLowerCase()]))
                        } */
                        task['Lead'] = show_trainer_pod.get(github_username_mapping[task['GitHub username'].toLowerCase()]) || "Unknown Pod";
                    }
                }
                
                console.log('Tasks Info:', tasks_info);

                // current_domain = tasks_info[0]['Domain'] // current domain is the last submitted domain as of now
                current_domain = 'smart_home' // current domain is the last submitted domain as of now
                document.getElementById('currentDomain').textContent = current_domain;
                tasks_occurred = new Set();
                tasks_completed = 0;
                merged_tasks = 0;
                discarded_tasks = 0;
                ready_to_merge_tasks = 0;
                for (const task of tasks_info) {
                    if (task['Domain'] == current_domain && !tasks_occurred.has(task['Task'])) {
                        tasks_completed += 1;
                        if (task['Pull Request Status'] === 'Merged') {
                            merged_tasks += 1;
                        }
                        if (task['Pull Request Status'] === 'ready to merge') {
                            ready_to_merge_tasks += 1;
                        }
                        if (task['Pull Request Status'] === 'discarded') {
                            discarded_tasks += 1;
                        }
                        tasks_occurred.add(task['Task']);
                    }
                }
                const TASKS_TO_BE_COMPLETED = 200; 
                analytics = {
                    totalTasks: tasks_completed,
                    activePods: pods.size,
                    totalMergedTasks: merged_tasks,
                    totalDiscardedTasks: discarded_tasks,
                    readyToMergeTasks: ready_to_merge_tasks,
                    completionRate: (merged_tasks / TASKS_TO_BE_COMPLETED * 100).toFixed(2)
                };
                // Update analytics if data is provided
                // if (data.analytics) {
                updateAnalytics(analytics);
                // }

                // Populate dropdowns and render table
                populateDropdowns();
                renderTable();
                
                setTimeout(() => {
                    reloadBtn.innerHTML = originalText;
                    reloadBtn.disabled = false;
                }, 2000);
            })
            .catch(error => {
                console.error('Error reloading tracker data:', error);
                reloadBtn.innerHTML = '❌ Error';
                setTimeout(() => {
                    reloadBtn.innerHTML = originalText;
                    reloadBtn.disabled = false;
                }, 2000);
            });
        }

        // Function to update analytics display
        function updateAnalytics(analytics) {
            if (analytics.totalTasks !== undefined) {
                document.getElementById('totalTasks').textContent = analytics.totalTasks;
            }
            if (analytics.activePods !== undefined) {
                document.getElementById('activePods').textContent = analytics.activePods;
            }
            if (analytics.totalMergedTasks !== undefined) {
                document.getElementById('totalMergedTasks').textContent = analytics.totalMergedTasks;
            }
            if (analytics.totalDiscardedTasks !== undefined) {
                document.getElementById('totalDiscardedTasks').textContent = analytics.totalDiscardedTasks;
            }
            if (analytics.readyToMergeTasks !== undefined) {
                document.getElementById('readyToMergeTasks').textContent = analytics.readyToMergeTasks;
            }
            if (analytics.completionRate !== undefined) {
                document.getElementById('completionRate').textContent = analytics.completionRate + '%';
            }
        }

        // Function to apply filters
        function applyFilters() {
            renderTable();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to filters
            document.querySelectorAll('.filter-select, .filter-input').forEach(element => {
                element.addEventListener('change', applyFilters);
            });

            // Show initial loading message
            document.getElementById('tasksDisplay').innerHTML = '<div class="no-data">Click "Reload Data" to load task information</div>';

            // Initial data load
            reloadTrackerData();
        });
    </script>   
</head>
<body>
    <header class="dashboard-header">
        <a href='/'> <div class="logo">
            <img src="{{ url_for('static', filename='images/turing_logo.svg') }}" alt="turing image" style="width: 100px; scale: 1.5; display: block; margin: 0 auto;">
        </div></a>
    </header>

    <!-- Task Tracker Section -->
    <section class="task-tracker-section">
        <div class="tracker-header">
            <div class="header-visual">
                <div class="task-icon">
                    <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="taskGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge> 
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <!-- Task board background -->
                        <rect x="20" y="25" width="80" height="70" rx="8" fill="url(#taskGradient)" opacity="0.3" filter="url(#glow)"/>
                        
                        <!-- Task cards/items -->
                        <rect x="30" y="35" width="60" height="8" rx="4" fill="url(#taskGradient)" opacity="0.8"/>
                        <rect x="30" y="48" width="45" height="8" rx="4" fill="url(#taskGradient)" opacity="0.6"/>
                        <rect x="30" y="61" width="55" height="8" rx="4" fill="url(#taskGradient)" opacity="0.9"/>
                        <rect x="30" y="74" width="40" height="8" rx="4" fill="url(#taskGradient)" opacity="0.7"/>
                        
                        <!-- Progress indicators -->
                        <circle cx="25" cy="39" r="3" fill="#4CAF50" opacity="0.9"/>
                        <circle cx="25" cy="52" r="3" fill="#FFA726" opacity="0.9"/>
                        <circle cx="25" cy="65" r="3" fill="#4CAF50" opacity="0.9"/>
                        <circle cx="25" cy="78" r="3" fill="#FF6B6B" opacity="0.9"/>
                        
                        <!-- Analytics chart -->
                        <path d="M 25 105 Q 35 100, 45 102 T 65 98 T 85 95 T 95 90" stroke="url(#taskGradient)" stroke-width="3" fill="none" opacity="0.8"/>
                        <circle cx="35" cy="101" r="2" fill="url(#taskGradient)" opacity="0.9"/>
                        <circle cx="55" cy="100" r="2" fill="url(#taskGradient)" opacity="0.9"/>
                        <circle cx="75" cy="96" r="2" fill="url(#taskGradient)" opacity="0.9"/>
                        <circle cx="95" cy="90" r="2" fill="url(#taskGradient)" opacity="0.9"/>
                    </svg>
                </div>
            </div>
            <h1>Task Tracker</h1>
            <div class="subtitle-container">
                <div class="subtitle-line"></div>
                <span class="subtitle">Real-Time Analytics Dashboard</span>
                <div class="subtitle-line"></div>
            </div>
            <p class="tracker-description">
                Comprehensive task analysis and monitoring system that provides real-time insights into task distribution, 
                completion rates, and performance metrics across all pods. Track the number of active tasks, monitor 
                workload distribution, and analyze productivity patterns to optimize Amazon agentic project workflow.
            </p>
        </div>

        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 2rem;">
            <h2 style="display: inline;"> Current Domain: <span id="currentDomain" style="font-weight: bold; color: #4CAF50;">?</span> </h2>
            
        </div>
        <!-- Analytics Overview -->
        <div class="analytics-container">
            <div class="analytics-card">
                <div class="analytics-number" id="totalTasks">?</div>
                <div class="analytics-label">Total Tasks</div>
                <div class="analytics-description">Completed tasks across all pods</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-number" id="totalMergedTasks">?</div>
                <div class="analytics-label">Total Merged Tasks</div>
                <div class="analytics-description">Merged tasks across all pods</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-number" id="totalDiscardedTasks">?</div>
                <div class="analytics-label">Total Discarded Tasks</div>
                <div class="analytics-description">Discarded tasks across all pods</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-number" id="readyToMergeTasks">?</div>
                <div class="analytics-label">Ready to Merge Tasks</div>
                <div class="analytics-description">Tasks ready to be merged across all pods</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-number" id="activePods">?</div>
                <div class="analytics-label">Active Pods</div>
                <div class="analytics-description">Currently operational Pods</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-number" id="completionRate">?%</div>
                <div class="analytics-label">Completion Rate</div>
                <div class="analytics-description">Overall merged/accepted tasks percentage</div>
            </div>
        </div>

        <!-- Filters Container -->
        <div class="filters-container">
            <div class="filters-header">
                <h2 class="filters-title">Filters & Controls</h2>
                <button id="reloadBtn" class="reload-button" onclick="reloadTrackerData()">
                    &#x21bb Reload Data
                </button>
            </div>
            
            <div class="filters-grid">
                <!-- <div class="filter-group">
                    <label class="filter-label" for="domainFilter">Week</label>
                    <select id="domainFilter" class="filter-select">
                        <option value="all">All Domains</option>
                    </select>
                </div> -->

                <div class="filter-group">
                    <label class="filter-label" for="weekFilter">Week</label>
                    <select id="weekFilter" class="filter-select">
                        <option value="all">All Weeks</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="podFilter">Pod</label>
                    <select id="podFilter" class="filter-select">
                        <option value="all">All Pods</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label" for="trainerFilter">Trainer</label>
                    <select id="trainerFilter" class="filter-select">
                        <option value="all">All Trainers</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label" for="complexityFilter">Complexity</label>
                    <select id="complexityFilter" class="filter-select">
                        <option value="all">All Complexities</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tasks Display Container -->
        <div class="tasks-container">
            <div class="tasks-header">
                <span>Task Distribution</span>
                <span style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Real-time task monitoring</span>
            </div>
            
            <!-- This is where your task data table will be displayed -->
            <div id="tasksDisplay" style="color: rgba(255, 255, 255, 0.6); text-align: center; padding: 2rem;">
                Loading task data...
            </div>
        </div>
    </section>
</body>
</html>