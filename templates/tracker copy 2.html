<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <title>Task Tracker - Turing Tooling</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        h1, h2 {
            color: #667eea !important;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: black;
            min-height: 100vh;
            color: white;
        }

        .dashboard-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .task-tracker-section {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .tracker-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .tracker-header h1 {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tracker-description {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
        }

        .filters-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .filters-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }

        .reload-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .reload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .reload-button:active {
            transform: translateY(0);
        }

        .reload-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .filter-select, .filter-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .filter-select option {
            background: #2a2a2a;
            color: white;
        }

        .analytics-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .analytics-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-5px);
        }

        .analytics-number {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .analytics-label {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1rem;
        }

        .analytics-description {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.4;
        }

        .tasks-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            min-height: 400px;
        }

        .tasks-header {
            font-size: 1.3rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .task-table th,
        .task-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .task-table th {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-weight: 600;
            font-size: 0.9rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .task-table td {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
        }

        .task-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .week-cell {
            font-weight: 600;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .date-cell {
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .name-cell {
            color: #4CAF50;
            font-weight: 500;
        }

        .total-cell {
            background: rgba(102, 126, 234, 0.15);
            font-weight: bold;
            color: #667eea;
        }

        .complexity-expert {
            color: #ff6b6b;
            font-weight: 600;
        }

        .complexity-hard {
            color: #ffa726;
            font-weight: 600;
        }

        .complexity-medium {
            color: #66bb6a;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 15px;
        }

        .no-data {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            padding: 3rem;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .task-tracker-section {
                padding: 0 1rem;
            }

            .tracker-header h1 {
                font-size: 2.2rem;
            }

            .tracker-description {
                font-size: 1rem;
            }

            .filters-container {
                padding: 1.5rem;
            }

            .filters-header {
                flex-direction: column;
                gap: 1rem;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .analytics-container {
                grid-template-columns: 1fr;
            }

            .analytics-number {
                font-size: 2rem;
            }

            .task-table th,
            .task-table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
        }
    </style>
    <script>
        var github_username_mapping = new Object();
        var tasks_info = null;
        var username_email_mapping = {};
        
        ////////// TEAM STRUCTURE CONSTANTS ////////////
        var pods = new Set();
        var calibrators = new Set();
        var trainers = new Set();
        var pod_trainers = new Map();
        ////////// TEAM STRUCTURE CONSTANTS ////////////

        // Function to get day name from date
        function getDayName(dateString) {
            const date = new Date(dateString);
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }

        // Function to populate dropdown options
        function populateDropdowns() {
            populateWeekDropdown();
            populatePodDropdown();
            populateTrainerDropdown();
            populateComplexityDropdown();
        }

        function populateWeekDropdown() {
            const weekSelect = document.getElementById('weekFilter');
            const weeks = new Set();
            
            if (tasks_info) {
                tasks_info.forEach(task => {
                    if (task['Week num']) {
                        weeks.add(task['Week num']);
                    }
                });
            }

            weekSelect.innerHTML = '<option value="all">All Weeks</option>';
            Array.from(weeks).sort().forEach(week => {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = week.replace('_', ' ').toUpperCase();
                weekSelect.appendChild(option);
            });
        }

        function populatePodDropdown() {
            const podSelect = document.getElementById('podFilter');
            const podsList = Array.from(pods);
            
            podSelect.innerHTML = '<option value="all">All Pods</option>';
            podsList.forEach(pod => {
                if (pod && pod.trim()) {
                    const option = document.createElement('option');
                    option.value = pod;
                    option.textContent = pod;
                    podSelect.appendChild(option);
                }
            });
        }

        function populateTrainerDropdown() {
            const trainerSelect = document.getElementById('trainerFilter');
            const trainersList = Array.from(trainers);
            
            trainerSelect.innerHTML = '<option value="all">All Trainers</option>';
            trainersList.forEach(trainer => {
                if (trainer && trainer.trim()) {
                    const option = document.createElement('option');
                    option.value = trainer;
                    option.textContent = trainer;
                    trainerSelect.appendChild(option);
                }
            });
        }

        function populateComplexityDropdown() {
            const complexitySelect = document.getElementById('complexityFilter');
            const complexities = new Set();
            
            if (tasks_info) {
                tasks_info.forEach(task => {
                    if (task['Complexity']) {
                        complexities.add(task['Complexity']);
                    }
                });
            }

            complexitySelect.innerHTML = '<option value="all">All Complexities</option>';
            Array.from(complexities).sort().forEach(complexity => {
                const option = document.createElement('option');
                option.value = complexity;
                option.textContent = complexity.charAt(0).toUpperCase() + complexity.slice(1);
                complexitySelect.appendChild(option);
            });
        }

        // Function to generate table data based on filters
        function generateTableData() {
            if (!tasks_info || tasks_info.length === 0) {
                return null;
            }

            // Get filter values
            const weekFilter = document.getElementById('weekFilter').value;
            const podFilter = document.getElementById('podFilter').value;
            const trainerFilter = document.getElementById('trainerFilter').value;
            const complexityFilter = document.getElementById('complexityFilter').value;

            console.log('Filters:', {
                weekFilter,
                podFilter,
                trainerFilter,
                complexityFilter
            });

            // Filter tasks based on selected filters
            let filteredTasks = tasks_info.filter(task => {
                return (weekFilter === 'all' || task['Week num'] === weekFilter) &&
                       (podFilter === 'all' || task['Pod Lead'] === podFilter) &&
                       (trainerFilter === 'all' || github_username_mapping[task['GitHub username']] === trainerFilter) &&
                       (complexityFilter === 'all' || task['Complexity'] === complexityFilter);
            });

            // Group by week, date, and user
            const groupedData = {};
            
            filteredTasks.forEach(task => {
                const week = task['Week num'] || 'Unknown Week';
                const createdDate = new Date(task['Created Date (completed)']);
                const dateKey = createdDate.toISOString().split('T')[0]; // YYYY-MM-DD format
                const dayName = getDayName(task['Created Date (completed)']);
                const username = task['GitHub username'] || 'Unknown User';
                const actual_name = github_username_mapping[username] || username;
                const complexity = task['Complexity'] || 'unknown';

                if (!groupedData[week]) {
                    groupedData[week] = {};
                }
                if (!groupedData[week][dayName]) {
                    groupedData[week][dayName] = {
                        dayName: dayName,
                        users: {}
                    };
                }
                if (!groupedData[week][dayName].users[actual_name]) {
                    groupedData[week][dayName].users[actual_name] = {
                        expert: 0,
                        hard: 0,
                        medium: 0,
                        total: 0
                    };
                }

                groupedData[week][dayName].users[actual_name][complexity]++;
                groupedData[week][dayName].users[actual_name].total++;
            });

            return groupedData;
        }

        // Function to render the table
        function renderTable() {
            const tableData = generateTableData();
            const tableContainer = document.getElementById('tasksDisplay');
            
            if (!tableData || Object.keys(tableData).length === 0) {
                tableContainer.innerHTML = '<div class="no-data">No data available for the selected filters</div>';
                return;
            }

            // Get all unique users across all filtered data
            const allUsers = new Set();
            Object.values(tableData).forEach(weekData => {
                Object.values(weekData).forEach(dateData => {
                    Object.keys(dateData.users).forEach(user => allUsers.add(user));
                });
            });

            const users = Array.from(allUsers).sort();

            let tableHTML = `
                <div class="table-wrapper">
                    <table class="task-table">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Date</th>`;

            // Add user columns
            users.forEach(user => {
                tableHTML += `
                    <th colspan="4">${user}</th>`;
            });

            tableHTML += `</tr><tr>
                                <th></th>
                                <th></th>`;

            // Add complexity headers for each user
            users.forEach(user => {
                tableHTML += `
                    <th class="complexity-expert">Expert</th>
                    <th class="complexity-hard">Hard</th>
                    <th class="complexity-medium">Medium</th>
                    <th class="total-cell">Total</th>`;
            });

            tableHTML += `</tr></thead><tbody>`;

            // Add data rows
            Object.keys(tableData).sort().forEach(week => {
                const weekData = tableData[week];
                let weekTotals = {};
                users.forEach(user => {
                    weekTotals[user] = { expert: 0, hard: 0, medium: 0, total: 0 };
                });

                Object.keys(weekData).sort().forEach(date => {
                    const dateData = weekData[date];
                    tableHTML += `
                        <tr>
                            <td class="week-cell">${week.replace('_', ' ').toUpperCase()}</td>
                            <td class="date-cell">${dateData.dayName}</td>`;

                    users.forEach(user => {
                        const userData = dateData.users[user] || { expert: 0, hard: 0, medium: 0, total: 0 };
                        weekTotals[user].expert += userData.expert;
                        weekTotals[user].hard += userData.hard;
                        weekTotals[user].medium += userData.medium;
                        weekTotals[user].total += userData.total;

                        tableHTML += `
                            <td class="complexity-expert">${userData.expert}</td>
                            <td class="complexity-hard">${userData.hard}</td>
                            <td class="complexity-medium">${userData.medium}</td>
                            <td class="total-cell">${userData.total}</td>`;
                    });

                    tableHTML += `</tr>`;
                });

                // Add week total row
                tableHTML += `
                    <tr style="border-top: 2px solid rgba(102, 126, 234, 0.5);">
                        <td class="week-cell">${week.replace('_', ' ').toUpperCase()}</td>
                        <td class="total-cell">Total</td>`;

                users.forEach(user => {
                    tableHTML += `
                        <td class="complexity-expert total-cell">${weekTotals[user].expert}</td>
                        <td class="complexity-hard total-cell">${weekTotals[user].hard}</td>
                        <td class="complexity-medium total-cell">${weekTotals[user].medium}</td>
                        <td class="total-cell">${weekTotals[user].total}</td>`;
                });

                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table></div>`;
            tableContainer.innerHTML = tableHTML;
        }

        // Function to reload tracker data
        function reloadTrackerData() {
            const reloadBtn = document.getElementById('reloadBtn');
            const originalText = reloadBtn.innerHTML;
            const spinner = '<span class="loading-spinner"></span>';
            
            reloadBtn.innerHTML = spinner + ' Reloading...';
            reloadBtn.disabled = true;

            // Simulate API call to reload tracker data
            fetch('/tracker', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('Tracker data reloaded:', data);
                reloadBtn.innerHTML = 'Reloaded &#10003;';
                tasks_info = data.tasks_info || [];
                username_email_mapping = data.username_email_mapping || {};
                
                for (const user of username_email_mapping) {
                    if (user["Github Username"]) {
                        github_username_mapping[user['Github Username']] = user['Actual name'];
                    }
                }
                console.log('GitHub Username to Name Mapping:', github_username_mapping);
                
                for (const team_structure of data.team_structure) {
                    pods.add(team_structure['Pod Lead']);
                    calibrators.add(team_structure['Calibrator']);
                    
                    trainers_of_pod = new Set();
                    const partialKey = 'Trainer';
                    for (const key in team_structure) {
                        if (key.startsWith(partialKey)) {
                            trainers.add(team_structure[key]);
                        }
                        trainers_of_pod.add(team_structure[key])
                    }
                    pod_trainers.set(team_structure['Pod Lead'], trainers_of_pod);
                }

                console.log('Pods:', pod_trainers);
                
                // Update analytics if data is provided
                if (data.analytics) {
                    updateAnalytics(data.analytics);
                }

                // Populate dropdowns and render table
                populateDropdowns();
                renderTable();
                
                setTimeout(() => {
                    reloadBtn.innerHTML = originalText;
                    reloadBtn.disabled = false;
                }, 2000);
            })
            .catch(error => {
                console.error('Error reloading tracker data:', error);
                reloadBtn.innerHTML = '❌ Error';
                setTimeout(() => {
                    reloadBtn.innerHTML = originalText;
                    reloadBtn.disabled = false;
                }, 2000);
            });
        }

        // Function to update analytics display
        function updateAnalytics(analytics) {
            if (analytics.totalTasks) {
                document.getElementById('totalTasks').textContent = analytics.totalTasks;
            }
            if (analytics.activePods) {
                document.getElementById('activePods').textContent = analytics.activePods;
            }
            if (analytics.completionRate) {
                document.getElementById('completionRate').textContent = analytics.completionRate + '%';
            }
        }

        // Function to apply filters
        function applyFilters() {
            renderTable();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners to filters
            document.querySelectorAll('.filter-select, .filter-input').forEach(element => {
                element.addEventListener('change', applyFilters);
            });

            // Show initial loading message
            document.getElementById('tasksDisplay').innerHTML = '<div class="no-data">Click "Reload Data" to load task information</div>';
        });
    </script>   
</head>
<body>
    <header class="dashboard-header">
        <div class="logo">
            <img src="{{ url_for('static', filename='images/turing_logo.svg') }}" alt="turing image" style="width: 100px; scale: 1.5; display: block; margin: 0 auto;">
        </div>
    </header>

    <!-- Task Tracker Section -->
    <section class="task-tracker-section">
        <div class="tracker-header">
            <h1>Task Tracker</h1>
            <p class="tracker-description">
                Comprehensive task analysis and monitoring system that provides real-time insights into task distribution, 
                completion rates, and performance metrics across all pods. Track the number of active tasks, monitor 
                workload distribution, and analyze productivity patterns to optimize Amazon agentic project workflow.
            </p>
        </div>

        <!-- Analytics Overview -->
        <div class="analytics-container">
            <div class="analytics-card">
                <div class="analytics-number" id="totalTasks">?</div>
                <div class="analytics-label">Total Tasks</div>
                <div class="analytics-description">Active and completed tasks across all pods</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-number" id="activePods">?</div>
                <div class="analytics-label">Active Pods</div>
                <div class="analytics-description">Currently operational pod instances</div>
            </div>
            <div class="analytics-card">
                <div class="analytics-number" id="completionRate">?%</div>
                <div class="analytics-label">Completion Rate</div>
                <div class="analytics-description">Overall task completion percentage</div>
            </div>
        </div>

        <!-- Filters Container -->
        <div class="filters-container">
            <div class="filters-header">
                <h2 class="filters-title">Filters & Controls</h2>
                <button id="reloadBtn" class="reload-button" onclick="reloadTrackerData()">
                    &#x21bb Reload Data
                </button>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label" for="weekFilter">Week</label>
                    <select id="weekFilter" class="filter-select">
                        <option value="all">All Weeks</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label" for="podFilter">Pod</label>
                    <select id="podFilter" class="filter-select">
                        <option value="all">All Pods</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label" for="trainerFilter">Trainer</label>
                    <select id="trainerFilter" class="filter-select">
                        <option value="all">All Trainers</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label" for="complexityFilter">Complexity</label>
                    <select id="complexityFilter" class="filter-select">
                        <option value="all">All Complexities</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tasks Display Container -->
        <div class="tasks-container">
            <div class="tasks-header">
                <span>Task Distribution</span>
                <span style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Real-time task monitoring</span>
            </div>
            
            <!-- This is where your task data table will be displayed -->
            <div id="tasksDisplay" style="color: rgba(255, 255, 255, 0.6); text-align: center; padding: 2rem;">
                Loading task data...
            </div>
        </div>
    </section>
</body>
</html>